name: Google Sheets ‚ûú WordPress Auto Publisher

on:
  schedule:
    - cron: "0 */2 * * *"   # ÊØè 2 Â∞èÊó∂Ë∑ë‰∏ÄÊ¨°
  workflow_dispatch:        # ÊîØÊåÅÊâãÂä®ËøêË°å

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout repo
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Setup Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          echo "Using requirements.txt"
          pip install -r requirements.txt
        else
          echo "requirements.txt not found"
          exit 1
        fi

    # Step 4: Run app.py (Â∏¶ÈáçËØï + Ëá™Âä®Ê£ÄÊµãË∑ØÂæÑ)
    - name: Run app.py (with retry)
      env:
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        SPREADSHEET_ID:             ${{ secrets.SPREADSHEET_ID }}
        WORKSHEET_NAME:             ${{ secrets.WORKSHEET_NAME }}
        WP_BASE_URL:                ${{ secrets.WP_BASE_URL }}
        WP_USER:                    ${{ secrets.WP_USER }}
        WP_APP_PASSWORD:            ${{ secrets.WP_APP_PASSWORD }}
        LARK_WEBHOOK_URL:           ${{ secrets.LARK_WEBHOOK_URL }}
        FB_API_VERSION:             ${{ secrets.FB_API_VERSION }}
        FB_PAGE_ACCESS_TOKEN:       ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
        FB_PAGE_ID:                 ${{ secrets.FB_PAGE_ID }}
        FB_DELAY_MINUTES:           ${{ secrets.FB_DELAY_MINUTES }}
      run: |
        set -e

        echo "üü¢ Running app.py from repo root..."
        ls -lah

        APP="app.py"
        for i in 1 2; do
          echo "Attempt $i..."
          if python "$APP"; then
            echo "‚úÖ RUN SUCCESS"
            exit 0
          fi

          echo "‚ö†Ô∏è Failed, retrying after 10s..."
          sleep 10
        done

        echo "‚ùå Failed after 2 attempts."
        exit 1
